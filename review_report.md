# Obsidian Plugin Code Review Report

## ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical Issues)

### 1. Ribbon Icon çš„åˆ·æ–°æœºåˆ¶ (æ€§èƒ½ä¸ä½“éªŒ)
**ä½ç½®**: `src/lib/menu.ts` -> `AddRibbonIcon`
**é—®é¢˜**: ä»£ç ä¸­ä½¿ç”¨ `setInterval` æ¯ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡ WebSocket çŠ¶æ€ï¼Œå¹¶æ ¹æ®çŠ¶æ€**ç§»é™¤å¹¶é‡æ–°åˆ›å»º** Ribbon Iconã€‚
```typescript
plugin.ribbonIconInterval = window.setInterval(() => {
    // ...
    plugin.ribbonIcon.remove() // âŒ é¢‘ç¹æ“ä½œ DOM
    plugin.ribbonIcon = plugin.addRibbonIcon(...) // âŒ é¢‘ç¹åˆ›å»º
}, 1000)
```
**å½±å“**:
- **æ€§èƒ½æŸè€—**: æ¯ç§’æ“ä½œ DOMï¼Œè™½ç„¶å¼€é”€ä¸å¤§ä½†å®Œå…¨æ²¡æœ‰å¿…è¦ã€‚
- **ç”¨æˆ·ä½“éªŒ**: å›¾æ ‡å¯èƒ½ä¼šé—ªçƒï¼Œä¸”åœ¨ç•Œé¢ä¸Šçš„ä½ç½®å¯èƒ½ä¼šè·³åŠ¨ï¼ˆå¦‚æœå…¶ä»–æ’ä»¶ä¹Ÿåœ¨åŠ è½½å›¾æ ‡ï¼‰ã€‚
- **å†…å­˜æ³„æ¼é£é™©**: è™½ç„¶ç§»é™¤äº† DOMï¼Œä½†é¢‘ç¹åˆ›å»ºå›è°ƒå‡½æ•°å¯èƒ½å¯¼è‡´ GC å‹åŠ›ã€‚

**å»ºè®®**:
- ä¸è¦ä½¿ç”¨è½®è¯¢ (`setInterval`)ã€‚
- åœ¨ WebSocket çŠ¶æ€å˜åŒ–çš„å›è°ƒä¸­ï¼ˆ`onopen`, `onclose`, `onerror`ï¼‰ç›´æ¥æ›´æ–°å›¾æ ‡ã€‚
- ä½¿ç”¨ `setIcon` (Obsidian API) æ¥æ›´æ”¹ç°æœ‰å›¾æ ‡çš„ SVGï¼Œè€Œä¸æ˜¯åˆ é™¤é‡å»ºã€‚æˆ–è€…é€šè¿‡æ·»åŠ /ç§»é™¤ CSS class æ¥æ”¹å˜å›¾æ ‡é¢œè‰²/çŠ¶æ€ã€‚

### 2. æ½œåœ¨çš„æ— é™åŒæ­¥å¾ªç¯é£é™©
**ä½ç½®**: `src/lib/fs.ts` -> `ReceiveNoteSyncModify`
**é—®é¢˜**: å½“ä»è¿œç«¯æ¥æ”¶åˆ°æ–‡ä»¶ä¿®æ”¹å¹¶å†™å…¥æœ¬åœ°æ—¶ï¼š
```typescript
await plugin.app.vault.modify(file, data.content, ...)
```
è¿™ä¼šè§¦å‘ `vault.on('modify')` äº‹ä»¶ï¼Œè¿›è€Œè§¦å‘ `NoteModify`ã€‚è™½ç„¶ä½ ä½¿ç”¨äº† `SyncSkipFiles` å“ˆå¸Œæ¯”å¯¹æ¥é˜²æ­¢å›ç¯ï¼Œä½†è¿™ç§æœºåˆ¶ä¾èµ–äºå†…å­˜çŠ¶æ€ã€‚å¦‚æœæ’ä»¶é‡è½½æˆ–å´©æºƒï¼Œå†…å­˜çŠ¶æ€ä¸¢å¤±ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„åŒæ­¥è¡Œä¸ºã€‚
**å»ºè®®**:
- ç¡®ä¿ `SyncSkipFiles` çš„æ¸…ç†é€»è¾‘å¥å£®ã€‚
- è€ƒè™‘åœ¨ `modify` æ—¶ä¸´æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œæˆ–è€…ä½¿ç”¨æ›´æŒä¹…çš„å…ƒæ•°æ®æ ‡è®°ï¼ˆè™½ç„¶å†…å­˜æ ‡è®°é€šå¸¸ä¹Ÿå¤Ÿç”¨ï¼Œä½†éœ€è°¨æ…ï¼‰ã€‚

## ğŸŸ¡ æ”¹è¿›å»ºè®® (Improvements)

### 1. ä¾èµ–ç®¡ç†
**ä½ç½®**: `package.json`
**é—®é¢˜**: å¼•å…¥äº† `dayjs`ã€‚
**å»ºè®®**: Obsidian å†…ç½®äº† `moment.js` (é€šè¿‡ `import { moment } from 'obsidian'`)ã€‚ä¸ºäº†å‡å°æ’ä»¶ä½“ç§¯ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ `moment` æ›¿ä»£ `dayjs`ï¼Œé™¤éæœ‰ `moment` æ— æ³•æ»¡è¶³çš„ç‰¹å®šéœ€æ±‚ã€‚

### 2. WebSocket ç­‰å¾…é€»è¾‘
**ä½ç½®**: `src/lib/websocket.ts` -> `MsgSend`
**é—®é¢˜**: ä½¿ç”¨ `while` å¾ªç¯é…åˆ `sleep` è¿›è¡Œâ€œå¿™ç­‰å¾…â€ (Busy Wait)ã€‚
```typescript
while (this.isAuth != true) {
    await sleep(WEBSOCKET_RETRY_DELAY)
}
```
**å»ºè®®**:
- ä½¿ç”¨**æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)** æ¨¡å¼ã€‚å½“è¿æ¥æœªå°±ç»ªæ—¶ï¼Œå°†æ¶ˆæ¯ push åˆ°é˜Ÿåˆ—ä¸­ï¼›è¿æ¥å»ºç«‹å¹¶è®¤è¯æˆåŠŸåï¼Œç»Ÿä¸€å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚è¿™æ ·ä»£ç æ›´ä¼˜é›…ï¼Œä¹Ÿé¿å…äº†æ— è°“çš„ `sleep` è½®è¯¢ã€‚

### 3. è®¾ç½®é¡µé¢çš„ React æŒ‚è½½
**ä½ç½®**: `src/setting.tsx` -> `display()`
**é—®é¢˜**: æ¯æ¬¡ `display()` è¢«è°ƒç”¨ï¼ˆä¾‹å¦‚åˆ‡æ¢è®¾ç½® Tab æ—¶ï¼‰ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ React Rootã€‚
```typescript
const apiSetReact = createRoot(apiSet)
apiSetReact.render(<SettingsView plugin={this.plugin} />)
```
**å»ºè®®**: è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„åšæ³•ï¼Œä½†åœ¨ `hide()` æˆ–ç»„ä»¶å¸è½½æ—¶ï¼Œæœ€å¥½æ˜¾å¼è°ƒç”¨ `root.unmount()` ä»¥é˜²æ­¢æ½œåœ¨çš„å†…å­˜æ³„æ¼ï¼ˆè™½ç„¶ Obsidian ä¼šæ¸…ç©º DOMï¼Œä½† React çš„äº‹ä»¶ç›‘å¬å¯èƒ½æ®‹ç•™ï¼‰ã€‚

### 4. é”™è¯¯å¤„ç†ä¸æ—¥å¿—
**ä½ç½®**: `src/lib/helps.ts` -> `dump`
**é—®é¢˜**: `dump` å‡½æ•°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¢«æ³¨é‡Šæ‰äº† `console.log`ã€‚
**å»ºè®®**: å»ºè®®ä¿ç•™ä¸€ä¸ª debug æ¨¡å¼å¼€å…³ã€‚å½“ç”¨æˆ·é‡åˆ°åŒæ­¥é—®é¢˜æ—¶ï¼Œå¼€å¯ debug æ¨¡å¼å¯ä»¥çœ‹åˆ°æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚

### 5. ç¡¬ç¼–ç çš„é‡è¯•ç­–ç•¥
**ä½ç½®**: `src/lib/websocket.ts`
**é—®é¢˜**: é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿæ˜¯ç¡¬ç¼–ç çš„å¸¸é‡ã€‚
**å»ºè®®**: å¯ä»¥åœ¨è®¾ç½®ä¸­æš´éœ²è¿™äº›å‚æ•°ï¼Œæˆ–è€…ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³• (Exponential Backoff) æ¥å¤„ç†é‡è¿ï¼Œé¿å…æœåŠ¡å™¨æ•…éšœæ—¶å®¢æˆ·ç«¯å‘èµ·é£æš´å¼çš„é‡è¿è¯·æ±‚ã€‚

## ğŸŸ¢ ä»£ç é£æ ¼ (Code Style)

- **ç±»å‹å®‰å…¨**: `src/main.ts` ä¸­ `SyncSkipFiles` æ¥å£å®šä¹‰ä¸º `[key: string]: string`ï¼Œä½†åœ¨ä½¿ç”¨æ—¶æœ‰æ—¶å­˜çš„æ˜¯ hash (string)ï¼Œæœ‰æ—¶å­˜çš„æ˜¯æ ‡è®°ã€‚å»ºè®®æ˜ç¡®ç±»å‹ã€‚
- **å‘½åè§„èŒƒ**: å˜é‡åå»ºè®®ç»Ÿä¸€ä½¿ç”¨ camelCaseï¼ˆå°é©¼å³°ï¼‰ï¼Œä¾‹å¦‚ `SyncSkipFiles` -> `syncSkipFiles`ã€‚

---

### æ€»ç»“
æ’ä»¶çš„æ ¸å¿ƒé€»è¾‘æ˜¯æ¸…æ™°çš„ï¼Œä¸»è¦é—®é¢˜é›†ä¸­åœ¨ **Ribbon Icon çš„è½®è¯¢æ›´æ–°** å’Œ **WebSocket çš„å‘é€ç­‰å¾…æœºåˆ¶**ã€‚ä¿®å¤è¿™ä¸¤ç‚¹å¯ä»¥æ˜¾è‘—æå‡æ’ä»¶çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚
